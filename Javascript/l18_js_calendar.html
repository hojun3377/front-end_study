<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>JavaScript calendar</title>
    <link rel="stylesheet" href="./css/l18_calendar.css">
  </head>
  <body>
    <main>
      <h1>일정 등록 달력 만들기</h1>
      <!-- table#calendarTable>(thead>tr>(th{일}+th{화}+th{화}+th{수}+th{목}+th{금}+th{토}))+(tbody>(tr>td(div.date_container>h5.date+ul.schedule>li*5)*7)*6) -->
      <div class="controler-container">
        <div id="calendarControler" class="controler-content">
          <input type="month">
          <div class="btn-container">
            <button type="button" value="">이전</button>
            <button type="button" value="">다음</button>
          </div>
        </div>
      </div>
      <table id="calendarTable">
        <thead>
          <tr>
            <th>일</th>
            <th>화</th>
            <th>화</th>
            <th>수</th>
            <th>목</th>
            <th>금</th>
            <th>토</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
            <td>
              <div class="date_container">
                <h5 class="date"></h5>
                <ul class="schedule"></ul>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div id="scheduleModal" class="modal-container">
        <div class="modal-content">
          <h1 class="date"></h1>
          <form action="" name="modalForm">
            <div class="controler-container">
              <input type="time" name="addTime" value="">
              <input type="text" name="" value="">
              <input type="button" name="addBtn" value="추가">
            </div>
            <ul class="modal-schedule"></ul>
            <div class="btn-container">
              <input type="button" name="closeBtn" value="닫기">
              <input type="button" name="submitBtn" value="확인">
            </div>
          </form>
        </div>
      </div>
    </main>
  </body>
<script>
// db json
const strJSON = {
  9 : '{"d_2021_9_2":{"430":"기상","450":"출근","1080":"퇴근","1170":"집도착","1328":"취침"},"d_2021_9_15":{"430":"기상","450":"출근","1080":"퇴근","1170":"집도착","1328":"취침"}}'
}

// calendar
const calendarControler = document.getElementById("calendarControler");
const calendarTable = document.getElementById("calendarTable");
const calendarDateEl = calendarTable.getElementsByTagName("td");
const calendarSchedule = calendarTable.getElementsByClassName("schedule");
const preMonthBtn = calendarControler.getElementsByClassName("btn-container")[0].children[0];
const nextMonthBtn = calendarControler.getElementsByClassName("btn-container")[0].children[1];

// modal
const scheduleModal = document.getElementById("scheduleModal");
const modalDate = scheduleModal.getElementsByClassName("date")[0];
const modalForm = document.forms.modalForm;

const Calendar = function(schedule='{}',year=new Date().getFullYear(),month=new Date().getMonth()+1) {
  this.year = year;
  this.month = month;
  this.firstDay = new Date(year,month-1,1).getDay();
  this.lastDate = new Date(year,month,0).getDate();
  this.preMonthDate = new Date(year,month-1,0).getDate();
  // this.text = `${year}년 ${month}월`;
  // this.value = year+"-"+(month<10 ? "0"+month : month);
  this.value = year+"-"+(month+"").padStart(2,0);
  this.preValue = `${month==1 ? year-1 : year}-${month==1 ? 12 : month-1}`;
  this.nextValue = `${year+(month==12 ? 1 : 0)}-${month==12 ? 1 : month+1}`;
  this.schedule = JSON.parse(schedule);

  this.setCalendar = (year,month) => {
    year = Number(year);
    month = Number(month);

    this.year = year;
    this.month = month;
    this.firstDay = new Date(year,month-1,1).getDay();
    this.lastDate = new Date(year,month,0).getDate();
    this.preMonthDate = new Date(year,month-1,0).getDate();
    // this.text = `${year}년 ${month}월`;
    // this.value = year+"-"+(month<10 ? "0"+month : month);
    this.value = year+"-"+(month+"").padStart(2,0);
    this.preValue = `${month==1 ? year-1 : year}-${month==1 ? 12 : month-1}`;
    this.nextValue = `${year+(month==12 ? 1 : 0)}-${month==12 ? 1 : month+1}`;
  }
}
const calendarPrint = function(calendar) {
  calendarControler.children[0].value = calendar.value;
  preMonthBtn.value = calendar.preValue;
  nextMonthBtn.value = calendar.nextValue;

  let dateNumElement,
      dateNum;

  dateNum=calendar.preMonthDate-calendar.firstDay+1;
  for(let i=0; i<calendar.firstDay; i++,dateNum++) {
    dateNumElement = calendarDateEl[i].getElementsByClassName("date")[0];

    if(calendarSchedule[i].children.length) {
      Array.from(calendarSchedule[i].children).forEach((item, i) => {
        item.remove();
      });
    }

    calendarDateEl[i].classList.remove("active");
    calendarDateEl[i].classList.add("disable");
    calendarDateEl[i].removeEventListener("click", calendarClickEventHandler.date);
    dateNumElement.innerText = dateNum;
  }
  for(let i=calendar.firstDay,dateNum=1; dateNum<=calendar.lastDate; i++,dateNum++) {
    let dateEl = calendarDateEl[i].getElementsByClassName("date")[0];
    let scheduleKey = `d_${calendar.year}_${calendar.month}_${dateNum}`;

    // ajax통신이 안되므로 대신 json을 만듬
    // 실제로는 json 객체로부터 그리기
    Array.from(calendarSchedule[i].children).forEach(item => {
      item.remove();
    });
    if(calendar.schedule[scheduleKey]!==undefined) {
      for(key in calendar.schedule[scheduleKey]) {
        let todo = document.createElement("li");
        todo.innerText = calendar.schedule[scheduleKey][key];
        calendarSchedule[i].append(todo);
      }
    }

    calendarDateEl[i].value = `${calendar.year}-${calendar.month}-${dateNum}`;
    calendarDateEl[i].classList.remove("disable");
    calendarDateEl[i].classList.add("active");
    calendarDateEl[i].addEventListener("click", calendarClickEventHandler.date);
    dateEl.innerText=dateNum;
  }
  dateNum=1;
  for(let i=calendar.firstDay+calendar.lastDate; i<calendarDateEl.length; i++,dateNum++) {
    let dateEl = calendarDateEl[i].getElementsByClassName("date")[0];

    if(calendarSchedule[i].children.length) {
      Array.from(calendarSchedule[i].children).forEach((item, i) => {
        item.remove();
      });
    }

    calendarDateEl[i].classList.remove("active");
    calendarDateEl[i].classList.add("disable");
    calendarDateEl[i].removeEventListener("click", calendarClickEventHandler.date);
    dateEl.innerText=dateNum;
  }
};
const calendarClickEventHandler = {
  date : e => {
    let year = Number(e.currentTarget.value.split("-")[0]),
        month = Number(e.currentTarget.value.split("-")[1]),
        date = Number(e.currentTarget.value.split("-")[2]);

    let scheduleKey = `d_${year}_${month}_${date}`;
    modalDate.innerText = `${year}년 ${month}월 ${date}일`;
    scheduleModal.value = e.currentTarget;
    if(calendar.schedule[scheduleKey]!==undefined) {
      for(key in calendar.schedule[scheduleKey]) {
        let scheduleList = document.createElement("li"),
            date = document.createElement("b"),
            schedule = document.createElement("span"),
            deleteBtn = document.createElement("button");

        date.classList.add("date");
        date.innerText = (Number.parseInt(key/60)+"").padStart(2,0)+":"+(key%60+"").padStart(2,0);

        schedule.innerText = calendar.schedule[scheduleKey][key];

        deleteBtn.type = "button";
        deleteBtn.value = {date:scheduleKey,time:key};
        deleteBtn.classList.add("delete");
        deleteBtn.innerText="x";
        deleteBtn.onclick = calendarClickEventHandler.modalDltSchedule;

        scheduleList.append(date);
        scheduleList.append(schedule);
        scheduleList.append(deleteBtn);

        // schedule.name = "scheduleList";
        modalForm.getElementsByClassName("modal-schedule")[0].append(scheduleList);
      }
    }

    scheduleModal.style.display = "block";
  },
  changeMonth : e => {
    let year = e.currentTarget.value.split("-")[0],
        month = e.currentTarget.value.split("-")[1];
    calendar.setCalendar(year,month);
    calendarPrint(calendar);
  },
  modalAddSchedule : e => {
    
  },
  modalDltSchedule : e => {
    // let key = JSON.parse(e.target.value);
    // delete calendar.schedule[key.date][key.time];

    console.log(e.target.parentElement);
    e.target.parentElement.remove();
  },
  modalSubmit : e => {
    let date = scheduleModal.value;
    let key = `d_${date.value.split("-")[0]}_${Number(date.value.split("-")[1])}_${date.value.split("-")[2]}`;

    Array.from(date.getElementsByClassName("schedule")[0].children).forEach(item => {
      item.remove();
    });
    if(modalForm.scheduleList!==undefined){
      Array.from(modalForm.scheduleList).forEach((el, i) => {
        let todo = document.createElement("li");

        todo.innerText = el.value;
        date.getElementsByClassName("schedule")[0].append(todo);
        if(calendar.schedule[key]===undefined) {
          calendar.schedule[key] = [];
        }
        calendar.schedule[key][i] = el.value;
      });
    }

    // ajax 통신
    // strJSON = JSON.stringify(todoJSON);

    calendarClickEventHandler.modalClose();
  },
  modalClose : () => {
    modalDate.innerText = "";
    Array.from(modalForm.getElementsByClassName("modal-schedule")[0].children).forEach(el => {
      el.remove();
    });
    scheduleModal.style.display = "none";
  }
}

const calendar = new Calendar(strJSON[9]);
calendarPrint(calendar);
preMonthBtn.onclick = calendarClickEventHandler.changeMonth;
nextMonthBtn.onclick = calendarClickEventHandler.changeMonth;
calendarControler.children[0].onchange = calendarClickEventHandler.changeMonth;
modalForm.submitBtn.onclick = calendarClickEventHandler.modalSubmit;
modalForm.closeBtn.onclick = calendarClickEventHandler.modalClose;
window.onclick = function(e) {
  if(e.target == scheduleModal) {
    // initModal();
    calendarClickEventHandler.modalClose();
  }
}
</script>
</html>
